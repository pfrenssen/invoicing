<?php

/**
 * @file
 * Access and permission tests for the 'business owner' role.
 */

module_load_include('inc', 'test_traits', 'base');
module_load_include('inc', 'test_traits', 'business');
module_load_include('inc', 'test_traits', 'client');

class BusinessOwnerPathAccessTestCase extends AccessWebTestCase {

  use BaseTestHelper;
  use BusinessTestHelper;
  use ClientTestHelper;

  /**
   * {@inheritdoc}
   */
  protected $role = 'business owner';

  /**
   * {@inheritdoc}
   */
  protected $accessiblePaths = array(
    '<front>',
    'client/add',
    'clients',
    'dashboard',
    'user',
    'user/password',
    'user/register',
  );

  /**
   * {@inheritdoc}
   */
  protected $inaccessiblePaths = array(
    'admin',
    'admin/config',
    'admin/config/people',
    'admin/content',
    'admin/people',
    'admin/reports',
    'admin/structure',

    // @todo These will become accessible once we have 'edit/create own business'
    //  permissions.
    // @see http://atrium.pocomas.be/invoicing/node/1167
    'businesses',
    'business/add',
    'invoice/add',
    'node',
    'node/add',
  );

  /**
   * A business owned by the business owner.
   *
   * @var Business
   */
  protected $business1;

  /**
   * A business which is not owned by the business owner.
   *
   * @var Business
   */
  protected $business2;

  /**
   * A client owned by the business owner.
   *
   * @var Client
   */
  protected $client1;

  /**
   * A client which is not owned by the business owner.
   *
   * @var Client
   */
  protected $client2;

  /**
   * Returns test case metadata.
   */
  public static function getInfo() {
    return array(
      'name' => 'Business owner',
      'description' => 'Tests access permissions for the "business owner" role.',
      'group' => 'Invoicing - Access',
    );
  }

  /**
   * {@inheritdoc}
   */
  public function setUp() {
    parent::setUp();

    // Create two businesses, of which the first is owned by the business owner.
    $this->business1 = $this->createBusiness();
    $this->business1->save();
    $this->addBusinessToUser($this->business1, $this->user);

    $this->business2 = $this->createBusiness();
    $this->business2->save();

    // Add the paths to view, edit and delete the business. These should only be
    // accessible for the first business.
    $this->accessiblePaths[] = 'business/' . $this->business1->identifier();
    $this->accessiblePaths[] = 'business/' . $this->business1->identifier() . '/edit';
    $this->accessiblePaths[] = 'business/' . $this->business1->identifier() . '/delete';
    $this->inaccessiblePaths[] = 'business/' . $this->business2->identifier();
    $this->inaccessiblePaths[] = 'business/' . $this->business2->identifier() . '/edit';
    $this->inaccessiblePaths[] = 'business/' . $this->business2->identifier() . '/delete';

    // Add a client to each business. The business owner should only be able to
    // view, edit and delete their own clients.
    $this->client1 = $this->createClient(array('bid' => $this->business1->identifier()));
    $this->client1->save();
    $this->client2 = $this->createClient(array('bid' => $this->business2->identifier()));
    $this->client2->save();

    // Add the paths to view, edit and delete the client. These should only be
    // accessible for the first client.
    $this->accessiblePaths[] = 'client/' . $this->client1->identifier();
    $this->accessiblePaths[] = 'client/' . $this->client1->identifier() . '/edit';
    $this->accessiblePaths[] = 'client/' . $this->client1->identifier() . '/delete';
    $this->inaccessiblePaths[] = 'client/' . $this->client2->identifier();
    $this->inaccessiblePaths[] = 'client/' . $this->client2->identifier() . '/edit';
    $this->inaccessiblePaths[] = 'client/' . $this->client2->identifier() . '/delete';
  }
}
