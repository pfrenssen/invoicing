<?php

/**
 * @file
 * CRUD tests for the Tax rate module.
 */

module_load_include('inc', 'test_traits', 'base');
module_load_include('inc', 'test_traits', 'tax_rate');

class TaxRateCRUDTestCase extends InvoicingIntegrationTestCase {

  use BaseTestHelper;
  use TaxRateTestHelper;

  /**
   * {@inheritdoc}
   */
  protected $usersToCreate = array();

  /**
   * Returns test case metadata.
   */
  public static function getInfo() {
    return array(
      'name' => 'CRUD test',
      'description' => 'Tests the creating, reading, updating and deleting of tax rates.',
      'group' => 'Invoicing - Tax rate',
    );
  }

  /**
   * Tests creating, reading, updating and deleting of tax rates.
   */
  public function testTaxRateCRUD() {
    // Check that the database table exists and is empty.
    $this->assertTrue(db_table_exists('tax_rate'), 'The tax_rate database table exists.');
    $this->assertTaxRateTableEmpty('The tax rate database is initially empty.');

    // Check if a new tax rate can be saved to the database.
    $values = $this->randomTaxRateValues();
    $tax_rate = $this->createTaxRate($values['type'], $values);
    $tax_rate->save();
    $this->assertTaxRateTableNotEmpty('The tax rate database table is no longer empty after creating a tax rate.');

    // Check that the tax rate data can be read from the database.
    $retrieved_tax_rate = tax_rate_load($tax_rate->tid);
    $this->assertTaxRateProperties($retrieved_tax_rate, $values, 'The tax rate that was saved to the database can be read correctly.');

    // Update the tax rate and check that the new values were written to the
    // database.
    $new_values = $this->randomTaxRateValues($values['type']);
    unset($new_values['type']);
    $this->updateTaxRate($tax_rate, $new_values);
    $tax_rate->save();
    $this->assertTaxRateProperties($tax_rate, $new_values, 'The tax rate has been updated correctly.');

    // Delete the tax rate. The database should be empty again.
    $tax_rate->delete();
    $this->assertTaxRateTableEmpty('The tax rate can be deleted from the database.');
  }

}
